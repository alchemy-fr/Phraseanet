{% extends 'admin/publications/wrapper.html' %}

{% block content %}
<div>
  {% if error %}
    <div class="error alert alert-error">{{error}}</div>
  {% endif %}
  {% if feed.is_owner(user) %}
    <h2>{% trans 'Edition' %}</h2>

    <div>
        <div id="pub_icon" style="border:1px solid #ccc;width:42px;height:42px;float:left">
            <div class="thumb_wrapper" style="width:32px;margin:5px auto">
                <img id="img_before"src="{{ feed.get_icon_url() }}" style="width:32px;height:32px;"/>
            </div>
        </div>
        <div style='float:left;height: 42px;padding-top: 10px;'>
            <input id="fileupload-feed" type="file" name="files[]" accept="image/*" data-url="/admin/publications/feed/{{ feed.get_id() }}/iconupload/">
        </div>
    </div>
    <br style='clear:both' />
    <div id='upload-error' style='color:red'></div>
    <script>
        $(function () {
            $('#fileupload-feed').fileupload({
                dataType: 'json',
                singleFileUploads : true,
                sequentialUploads: true,
                add: function (e, data) {
                    $('#upload-error').empty();
                    $.each(data.files, function (index, file) {
                        var fileType = /^image\/(gif|jpeg|png)$/;
                        if(typeof loadImage == 'function' && fileType.test(file.type)){
                            if(file.size < 204800){ //200 ko
                                var options = {
                                    maxWidth: 32,
                                    maxHeight: 32,
                                    minWidth: 32,
                                    minHeight: 32
                                };

                                data.oldImage = $("#img_before").get(0);

                                loadImage(file, function(img){
                                    $("#img_before").remove();
                                    $("#pub_icon .thumb_wrapper").append(img);
                                    $("#pub_icon .thumb_wrapper img").attr("img_before");
                                    return false;
                                }, options);

                                data.submit();
                            } else {
                                $('#upload-error').empty().append(language.errorFileApiTooBig);
                            }
                        }
                    });
                },
                done: function (e, data) {
                    return false;
                }
            });

            $('#fileupload-feed').bind('fileuploadsubmit', function (e, data) {
                var jqXHR = $(this).fileupload('send', data)
                    .success(function(response){
                        if( ! response.success){
                          $("#pub_icon .thumb_wrapper").empty();
                          $('#upload-error').empty().append(response.message);
                          $("#pub_icon .thumb_wrapper").append(data.oldImage);
                        }
                    })
                    .error(function(jqXHR, textStatus, errorThrown) {
                        alert('error');
                    });

                    return false;
            });
        });
    </script>
    <form class="form_publication" name="form_publication" enctype="multipart/form-data" method="post" action="/admin/publications/feed/{{ feed.get_id() }}/update/">
      <div>
        <label for="edit_pub_titre">{% trans 'Titre' %}</label>
        <input class="required_text" id="edit_pub_titre" size="30" maxlength="128" name="title" type="text" value="{{ feed.get_title() }}" />
      </div>
      <div>
        <label for="edit_pub_subtitre">{% trans 'Sous-titre' %}</label>
        <input placeholder="{% trans 'Short description' %}" id="edit_pub_subtitre" size="30" maxlength="512" name="subtitle" type="text" value="{{ feed.get_subtitle() }}" />
      </div>
      <div>
        <label for="edit_pub_base_id">{% trans 'Etendue de la publication' %}</label>
        <select id="edit_pub_base_id" name="base_id" {% if feed.is_public() %}disabled="disabled"{% endif %}>
          <option value="">{% trans 'Non-Restreinte (publique)' %}</option>
        {% for databox in user.ACL().get_granted_sbas('bas_chupub') %}
          <optgroup label="{{ databox.get_viewname() }}">
          {% for collection in databox.get_collections() %}
            <option {% if feed.get_collection() and feed.get_collection().get_base_id() == collection.get_base_id() %}selected="selected"{% endif %} value="{{ collection.get_base_id() }}">{{ collection.get_name() }}</option>
          {% endfor %}
          </optgroup>
        {% endfor %}
        </select>
      </div>
      <div>
        <label for="edit_pub_public">{% trans 'Publique' %}</label>
        <input id="edit_pub_public" name="public" type="checkbox" value="1" {% if feed.is_public() %}checked="checked"{% endif %} />
      </div>
      <div>
        <button type="submit">{% trans 'boutton::valider' %}</button>
        <a href="/admin/publications/list/">{% trans 'boutton::annuler' %}</a>
      </div>
    </form>
    <div style="width:400px;">
      <h3>{% trans 'Liste des personnes habilitees a publier sur ce fil' %}</h3>
      <table class="admintable">
        <thead>
          <tr>
            <th>{% trans 'Id' %}</th>
            <th></th>
            <th>{% trans 'Email' %}</th>
            <th>{% trans 'Owner' %}</th>
          </tr>
        </thead>
        <tbody>
        {% for publisher in feed.get_publishers() %}
          <tr class="{% if loop.index is odd %}odd{% else %}even{% endif %}">
            <td>
              {{ publisher.get_user().get_id() }}
            </td>
            <td>
              {{ publisher.get_user().get_display_name() }}
            </td>
            <td>
              {{ publisher.get_user().get_email() }}
            </td>
            <td>
              {% if publisher.is_owner() == true %}
              X
              {% else %}
              <form class="form_publication" method="post" action="/admin/publications/feed/{{ feed.get_id() }}/removepublisher/">
                <input type="hidden" value="{{ publisher.get_id() }}" name="publisher_id"/>
                <button>{% trans 'boutton::supprimer' %}</button>
              </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    <div>
      <form class="form_publication" id="publisher_adder" method="post" action="/admin/publications/feed/{{ feed.get_id() }}/addpublisher/">
        <label>{% trans 'Ajouter un publisher' %}</label>
        <input placeholder="{% trans 'Name or email' %}" class="publish_adder"/>
        <input type="hidden" name="usr_id"/>
      </form>
    </div>
    </div>
    <style>
      .ui-autocomplete {
        max-height: 200px;
        overflow-y: auto;
        /* prevent horizontal scrollbar */
        overflow-x: hidden;
        /* add padding to account for vertical scrollbar */
        padding-right: 20px;
      }
      /* IE 6 doesn't support max-height
     * we use height instead, but this forces the menu to always be this tall
     */
      * html .ui-autocomplete {
        height: 200px;
      }
      .ui-autocomplete-loading { background: white url('/skins/icons/ui-anim_basic_16x16.gif') right center no-repeat; }
    </style>
    <script type="text/javascript">
        $(document).ready(function(){
            $( ".publish_adder" ).autocomplete({
                    source: "/admin/users/typeahead/search/?filter_rights[]=bas_chupub",
                    minLength: 2,
                    select: function( event, ui ) {
                        var form = $('#publisher_adder');
                        $('input[name="usr_id"]', form).val(ui.item.id);
                        form.submit();
                    }
            }).data( "autocomplete" )._renderItem = function( ul, item ) {
                var email = item.email ? '<br/>'+item.email : '';
                var login = item.login != item.name ? " ("+ item.login +")" : '';
                return $( "<li></li>" )
                .data( "item.autocomplete", item )
                .append( "<a>" + item.name + login + email + "</a>" )
                .appendTo( ul );
            };
        });
    </script>
  {% else %}
    {% trans 'You are not the feed owner' %}
    <a href="/admin/publications/list/">{% trans 'boutton::retour' %}</a>
  {% endif %}
</div>
{% endblock %}