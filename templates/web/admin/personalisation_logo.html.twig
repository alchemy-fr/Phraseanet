<table cellspacing="0">
    <tr class="personalise-logo-row-container">
        <td>
            {{ form_widget(form.logoChoice[0]) }}
            {{ form_label(form.logoChoice[0]) }}
            <div class="image-container">
                <img id="original-image-placeholder" alt="gabari"
                     src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAaCAYAAACzdqxAAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo0MDc2M0ZDM0NBMzYxMUU0QUYwRUQwNENCREZBRkU5NSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo0MDc2M0ZDNENBMzYxMUU0QUYwRUQwNENCREZBRkU5NSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjQwNzYzRkMxQ0EzNjExRTRBRjBFRDA0Q0JERkFGRTk1IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjQwNzYzRkMyQ0EzNjExRTRBRjBFRDA0Q0JERkFGRTk1Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8++5z4uQAABShJREFUeNqklWtsFUUUx8/M7uzeJ+29LdbaAo225SG0lxQoREUIBozGGBMTo8aYxkRDEC0RA2qMhkBoNEatIRC+EIPyUvmgDRED1moRqKVWWu0tlF4o2FZKH9D23ruvGc/s7UtSpNFNzp7ZnZnf+c+ZF8AUHiHEPLRjQvAT6CPwfx+EpKF9KMzExXjVxrbBo+UXhRlvx3870EL/1pfcAkjRlYHgb5tnv+ozat5dCE4SeMgLSkAHT8nmX9W8J8JA1C3Ybg8hRNwWjNBSfH/idEfVRNW6AjF4KTBax8MI9gMoXgJK+oxhFvnoHPEXWIhZh/D6ScEIzEJXwRNDDyQObdTsP2tmUB370HExPNMDig9ARTAdCUDSV1+i92zhGPE7bPImBuhzwQhk6NeDbZUPH/2036zeWUSYCUTnaA6aNRZeTB9XTH2o2stH5GlAczc2kqynMD3KdvyzW4JbzJbG5GDlprlg9evUg409CNQk2HbBMoALzvKhWoFQcANQ/aY8spwELaiMEn+hoILz0E/H62yRv7hDmAS4gfIMBYRFQJgUTQWQJoXJtFDiejLZtHvu7m/s6bCwNkyFAOvLD3Ys2nv8Qrjv4fI6Gsob4AiWcLAUF85NWaYuzF0ACAfK/6G0J3tb3atXV/IN9b8vwT83qDtEtL/Ot2cc3rpjST1EeviqtfVC+LkwsNpSXdXcxKlAPiiSjv+J6ubWzFrfuJuUX3i6Lrak+Wpn7shCICruJmN03qVv+7a6YKA2yEteWNsQtqJporWqgMgaF5ZKgVsMPxL7nq+6tu3naDGnLRqldHzJgpBNIIkh8IOPwe2kQVt3HVgUPdY73br/rdM0PKdXYDqIzG+g8PrlnO2nn/xlln/zD/WLk2ZSm2yTqTBBLY5ARpNDcb+TV7rS/3j/89LMlcvO5yx9NBbPJ+bHUZ75zY+1pcSnA/FpUtMkOxcTReRSdsEkpVqMVY49V6tPTfttaMWNQ+1BPdrZlK6nqTIrqeWNBY6N6UQwpkLF4aUYgqdUwxhbPkabGmqu9cyMzMTJTBgcEkPhDIfzM37dLsYuquCTKE5N7WgKUjaalgGina3yFs4aVL0l4wcA7jimKbhZSxLXWK8ORjfzmffCTenAEdCRHPOxOtzAHTX0TqdHyyxiGJAJB5et4tYpjIGq6eg1IIxl2IlgxnC30qpk96Wrqp014dxBxSSVCg586AIE2mJkeoTh8aHbBlYR15iSGomKQEX3oGqGYM01qrLZ8Rshx7bNM75pHQsIcTRKqEeV9AHBGuqd0Fz8jmjEAncq3MU6Yd9iMomGUAS7QIRTFeGahgGZQmlaiW3k9DH9cid2y6CoKPHO1/vAF07jpmWAZSfBQLUm+tS3CagGHO6kgAh2VeteUD0e0LHMdD9oug/CwWCg4sE1BqPKgAQvK4rM2VVb90Xva2+UNdqYU9MFmyk4li0MYDt4ysn8IlDCmUeaD80PXq8XnivObTr8WGH30jt8B3GckYkHfRjd1qGh4TWvv/IePXWiKc+joiKmg4Z+flFhV2x1KVzqj2fjygCG/1W0ortCVyruy00GmXIS+29CoV23upoWou1sbYnpG9ZW5A/0Dgd0VYcFxbO7uh9/CDquG9lyEjOCgeHty/POzQt5cO3Aywg8OZXbWV4AZY7txPbvPdKwPPK8eOmZLZ3PVjV1rtjfKA6c622wHH4R27w4cvH+p+u/Mh5PtO/bc6T5s5ae5rjlyOu/8nbX/1QDFKPVoFWjzZ9Kn78FGADjnoHwJIC7sQAAAABJRU5ErkJggg=="/>
            </div>
            <a id="download-image-template" href="#">{{ 'prod::setup: download gabari' | trans }}</a>
        </td>
        <td>
            {{ form_widget(form.logoChoice[1]) }}
            {{ form_label(form.logoChoice[1]) }}
            <br>
            <span id="help-text">{{ 'prod::setup: help text' | trans }}</span>
            <span id="error-text"></span>
            <div class="image-container" id="personalize-image-container">
                {% if app['conf'].get(['registry', 'general', 'personalize-logo-choice', 'personalizeFile']) == 'true' %}
                    <img id="personalise-image-placeholder" src="/custom/minilogos/personalize_logo.png"/>
                {% endif %}
            </div>
            <div>
                {{ form_widget(form.personalizeLogoInput) }}
                <label for="general_personalize-logo-choice_personalizeLogoInput"
                       id="select-logo-btn">{{ 'prod::setup: select file' | trans }}</label>
            </div>
        </td>
        {{ form_widget(form.personalizeFile) }}
    </tr>
</table>

<script type="text/javascript">
    $(document).ready(function () {
        var fileToUpload = null;

        var errorDimension = '{{ 'prod::setup: error text dimension' | trans }}';
        var errorFileType = '{{ 'prod::setup: error text file type' | trans }}';

        $('#help-text').show();

        // show personalize logo if exist
        {% if app['conf'].get(['registry', 'general', 'personalize-logo-choice', 'personalizeFile']) == 'true' %}
            $('#personalize-image-container').show();
        {% else %}
            $('#personalize-image-container').hide();
        {% endif %}

        $('#error-text').hide();

        $("#download-image-template").on('click', function (event) {
            event.preventDefault();
            var imageInBase64 = $('#original-image-placeholder').attr('src');
            var mimeInfo = base64MimeType(imageInBase64);
            var ext = mimeInfo.split('/').pop();
            var filename = $('#original-image-placeholder').attr('alt') + "." + ext;
            download(imageInBase64, filename, mimeInfo);
        });

        var base64MimeType = function base64MimeType(encoded) {
            var result = null;
            if (typeof encoded !== 'string') {
                return result;
            }
            var mime = encoded.match(/data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+).*,.*/);
            if (mime && mime.length) {
                result = mime[1];
            }
            return result;
        };

        $("#setupForm").fileupload({
            dataType: 'html',
            add: function (e, data) {
                $.each(data.files, function (i, file) {
                    var reader = new FileReader();

                    reader.readAsDataURL(data.files[0]);
                    reader.data = data;
                    reader.file = data.files[0];

                    reader.onload = function (_file) {
                        var image = new Image();

                        fileToUpload = _file.target.result;
                        image.src = _file.target.result;
                        image.file = this.file;
                        image.data = this.data;
                        image.onload = function () {
                            var w = this.width,
                                h = this.height;

                            var ext = this.file.type.split('/').pop().toLowerCase();
                            if (ext != 'png') {
                                $('#general_personalize-logo-choice_personalizeLogoInput').val("");
                                $('#error-text').text(errorFileType);
                                $('#error-text').show();
                                $('#help-text').hide();
                                $('#personalize-image-container').hide();
                                return false;
                            }

                            if (h >= 42 ) {
                                $('#error-text').text(errorDimension);
                                $('#error-text').show();
                                $('#help-text').hide();
                                $('#personalize-image-container').hide();
                                $('#general_personalize-logo-choice_personalizeLogoInput').val("");
                                return false;
                            }

                            require([
                                "blueimp.loadimage"
                            ], function (loadImage) {
                                loadImage(file, function (img) {
                                    $('#personalize-image-container').show();
                                    $('#error-text').hide();
                                    $('#help-text').hide();
                                    $('#personalize-image-container').empty().append(img);
                                }, {
                                    fileType: /^image\/(png)$/,
                                    maxSize: 5242880, // 5MB
                                    maxWidth: 52,
                                    maxHeight: 42,
                                });
                            });

                            var fd = new FormData();
                            fd.append("fileToUpload", fileToUpload);
                            $.ajax({
                                type: 'POST',
                                url: '{{ path('setup_send_personalize_logo') }}',
                                data: fd,
                                processData: false,
                                contentType: false,
                                async: false,
                                success: function (data) {
                                    if(data === 'success'){
                                        $('#general_personalize-logo-choice_personalizeFile').val(true);
                                    }else{
                                        $('#general_personalize-logo-choice_personalizeFile').val(false);
                                    }

                                    console.log(data);
                                }

                            });
                        }
                    }

                });

                return false;
            },
            submit: function (e, data) {
            },
            done: function (e, data) {
            }
        });

    });

</script>



