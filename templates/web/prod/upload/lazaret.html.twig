<div id="lazaretBox" class="container-fluid">

    {% if lazaretFiles is not none %}
        {% if lazaretFiles|length > 0 %}
            <div id="QUARANTINE_TOOLBAR_EMPTYING_MSG"></div>
            <div class="btn-toolbar">
                <div class="btn-group emptying" style="text-align:center; padding:5px 0;">
                    <button class="btn stopempty-lazaret" title="{% trans "Stop"%}">
                        <img src="/skins/icons/delete.png">
                        &nbsp;<span id="QUARANTINE_TOOLBAR_EMPTYING_TODO"> </span>&nbsp;{% trans "Stop"%}
                    </button>
                </div>
                <div class="btn-group empty" style="text-align:center; padding:5px 0;">
                    <button class="btn empty-lazaret" title="{% trans "Empty quarantine"%}">
                        <img src="/skins/icons/delete.png">{% trans "Empty quarantine"%}
                    </button>
                </div>
                <div class="btn-group empty" style="text-align:center; padding:5px 0;">
                    <button class="btn" title="{% trans "Page"%}">
                        {% trans "Page"%}
                    </button>
                    {% set items = lazaretFiles | length %}
                    {% set pages = (items / perPage) | ceil | min(10) %}

                    {% for i in 1..pages %}
                        <button class="btn page-lazaret{% if currentPage == i %} active{% endif %}" title="{{ i }}">
                            <a href="{{ path('lazaret_elements', { 'page' : i }) }}">
                            {{ i }}
                            </a>
                        </button>
                    {% endfor %}
                </div>
            </div>

            <ul class="unstyled">
                {% for file in lazaretFiles %}
                    <li class="row-fluid wrapper-item well">
                       {{ _self.lazaretElement(app, file) }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            {% trans "No document in quarantine" %}
        {% endif %}
    {% else %}
        {% trans "You do not have enough rights to access quarantine" %}
    {% endif %}
</div>

<script>
    $('document').ready(function(){
        $(".btn-group.emptying").hide();

        var scope = $('#lazaretBox');

        $("#tab-lazaret").scrollTop(0);

        function getLazaretId(el){
            return el.closest('div.lazaret-file').find('input[name=lazaret_file]').val();
        }

        function getDestinationId(el){
            return el.closest('div.lazaret-file').find('input[name=lazaret_file_destination]').val();
        }

        function startAjax(button){
            button.closest(".btn-group").find('button').attr('disabled', true);
            button.closest(".btn-group").addClass('loading');
        }

        function stopAjax(button){
            button.closest(".btn-group").find('button').attr('disabled', false);
            button.closest(".btn-group").removeClass('loading');
        }

        function reloadContent(force){
            var nbItems = scope.find(".wrapper-item").length;

            if( nbItems === 0 || force === true) {
                $.ajax({
                    url:'/prod/lazaret/',
                    beforeSend: function(){
                        $("#lazaretBox").empty().append(language.loading );
                    },
                    success: function(data) {
                        scope.empty().append(data);
                    },
                    error : function() {
                        $("#lazaretBox").empty().append(language.errorAjaxRequest);
                    }
                });
            }
        }

        $(".records-subititution .diapo", scope)
                . bind('click', function(e){
                    $(this).closest('.lazaret-proposals').find('.diapo').removeClass('selected');
                    $(this).addClass('selected');
                });

        $(".records-subititution .captionTips", scope).tooltip();
        $(".records-subititution .infoTips", scope).tooltip();
        $(".records-subititution .previewTips", scope).tooltip();

        var emptying = false;   // true=emptying, set to false to stop

        // stop emptying lazaret
        $('button.stopempty-lazaret', scope).bind('click', function() {
            emptying = false;
        });

        // empty lazaret
        $('button.empty-lazaret', scope).bind('click', function(){

            var that = $(this);

            if(!confirm("{% trans "Empty quarantine will remove all items, are you sure you want to continue ?" %}")) {
                return false;
            }

            $(".btn-group.empty").hide();
            $(".btn-group.emptying").show();

            var f = function() {
                var todo = 0;
                var msg_html = "";
                $.ajax({
                    type: 'POST',
                    url: '/prod/lazaret/empty/',
                    dataType: 'json',
                    data: {
                        "max": 10
                    },
                    success: function (data) {
                        if (data.success) {
                            todo = data.result.todo;
                            $("#QUARANTINE_TOOLBAR_EMPTYING_TODO").text(""+todo);
                        } else {
                            emptying = false;   // force stop
                            msg_html = _.template($("#alert_error_tpl").html(), {
                                content: data.message
                            });
                        }
                    },
                    error: function () {
                        emptying = false;   // force stop
                        msg_html = _.template($("#alert_error_tpl").html(), {
                            content: language.errorAjaxRequest
                        });
                    }
                })
                .done(function(data) {
                    if(emptying && todo > 0) {
                        window.setTimeout(f, 500);  // wait between loops
                    }
                })
                .fail(function() {
                    emptying = false;   // force stop
                })
                .always(function(){
                    if(!emptying || todo <= 0) {
                        $(".btn-group.emptying").hide();
                        $(".btn-group.empty").show();
                        if(msg_html != "") {
                            $("#QUARANTINE_TOOLBAR_EMPTYING_MSG").html(msg_html);
                        }
                        else {
                            reloadContent(true);
                        }
                    }
                });
            };

            // start emptying
            emptying = true;
            f();
        });

        //add lazaret file click action
        $("button.add-lazaret", scope).bind('click', function(){
            var that = $(this);
            var lazaretId = getLazaretId(that);
            var destinationCollectionId = getDestinationId(that);

            $.ajax({
                type : 'POST',
                url: '/prod/lazaret/'+lazaretId+'/force-add/',
                dataType: 'json',
                data : {
                    bas_id:destinationCollectionId,
                    keep_attributes: 1
                },
                beforeSend: function(){
                    startAjax(that);
                },
                success: function(data){
                    if(data.success){
                        that.closest(".wrapper-item").remove();
                    }else{
                        var html = _.template($("#alert_error_tpl").html(), {
                             content:data.message
                        });
                        that.closest(".diapo").append(html);
                    }
                },
                error: function(){
                   var html = _.template($("#alert_error_tpl").html(), {
                        content:language.errorAjaxRequest
                   });
                   that.closest(".diapo").append(html);
                },
                complete: function(){
                    stopAjax(that);
                    reloadContent();
                }
            });
        });

        //delete lazaret file click action
        $("button.delete-lazaret", scope).bind('click', function(){
            var that = $(this);
            var lazaretId = getLazaretId(that);

            $.ajax({
                type : 'POST',
                url: '/prod/lazaret/'+lazaretId+'/deny/',
                dataType: 'json',
                beforeSend: function(){
                    startAjax(that);
                },
                success: function(data){
                    if(data.success){
                        that.closest(".wrapper-item").remove();
                    }else{
                       var html = _.template($("#alert_error_tpl").html(), {
                            content:data.message
                       });
                       that.closest(".diapo").append(html);
                    }
                },
                error: function(){
                    var html = _.template($("#alert_error_tpl").html(), {
                        content:language.errorAjaxRequest
                    });
                    that.closest(".diapo").append(html);
                },
                complete: function(){
                    stopAjax(that);
                    reloadContent();
                }
            });
        });

        //substitute lazaret file click action
        $("button.subtitute-lazaret", scope).bind('click', function(){
            var that = $(this);
            var lazaretId = getLazaretId(that);
            var container = $(this).closest('.wrapper-item');
            var nbProposals = $('.records-subititution', container).length;
            if(nbProposals > 1){ // we got more than one proposals
                var elements = $(".selected", container).closest('.records-subititution');
                var nbElement = elements.length;
            }else if(nbProposals == 1){
                var elements = container.find(".records-subititution");
                var nbElement = 1
            }
            else{
                return false;
            }

            if(nbElement === 0){
                alert(language.selectOneRecord);
                return false;
            }else if(nbElement > 1){
                alert(language.onlyOneRecord);
                return false;
            }

            var recordId = elements.first().find('input[name=record_id]').val();

            $.ajax({
                type : 'POST',
                url: '/prod/lazaret/'+lazaretId+'/accept/',
                dataType: 'json',
                data:{
                    record_id: recordId
                },
                beforeSend: function(){
                   startAjax(that);
                },
                success: function(data){
                    if(data.success){
                        that.closest(".wrapper-item").remove();
                    }else{
                        var html = _.template($("#alert_error_tpl").html(), {
                            content:data.message
                        });
                        that.closest(".diapo").append(html);
                    }
                },
                error: function(){
                    var html = _.template($("#alert_error_tpl").html(), {
                        content:language.errorAjaxRequest
                    });
                    that.closest(".diapo").append(html);
                },
                complete: function(){
                    stopAjax(that);
                    reloadContent();
                }
            });
        });
    });
</script>

{% macro lazaretElement(app, file) %}
    {% import "common/thumbnail.html.twig" as thumb %}
    {% import 'prod/results/record.html.twig' as record_format %}
    {% set records = file.getRecordsToSubstitute(app, true) %}
    <div class="lazaret-file span4">
        <h5>{% trans "Last uploaded version" %}</h5>
        <ul class="thumbnails">
            <li class="span12" >
                <div class="thumbnail">
                    <img src="/prod/lazaret/{{ file.getId() }}/thumbnail/"/>
                    <div class="caption">
                        <p>{% trans "Filename" %} : <span class="info">{{ file.getOriginalName() }}</span></p>
                        <p>{% trans "Date" %} : <span class="info">{{ app['date-formatter'].getPrettyString(file.getCreated()) }}</span></p>
                        {% if file.getSession().getUser(app) is not none %}
                            <p>
                                {% set username = '<a href="#" class="username userTips" tooltipsrc="' ~ path('prod_tooltip_user', { 'usr_id' : file.getSession().getUser(app).get_id() }) ~ '/">' ~ file.getSession().getUser(app).get_display_name() ~ '</a>' %}
                                {% trans %}
                                    Uploaded by : {{ username }}
                                {% endtrans %}
                            </p>
                        {% endif %}
                        <p>{% trans "Collection" %} : <span class="info">{{ file.getCollection(app).get_label(app['locale.I18n']) }}</span></p>
                    </div>
                    <div class="caption">
                        {% for check in file.getChecks() %}
                            <p>{{ check.getMessage() }}</p>
                        {% endfor %}
                    </div>
                    <div class="btn-group" style="text-align:center; padding:5px;">
                        <button class="btn add-lazaret" title="{% trans "Add"%}">
                            <img src="/skins/icons/add.png">{% trans "Add"%}
                        </button>
                        <button class="btn delete-lazaret" title="{% trans "Delete"%}">
                            <img src="/skins/icons/delete.png">{% trans "Delete"%}
                        </button>
                        {% if records|length > 0 %}
                            <button class="btn subtitute-lazaret" title="{% trans "Substitute" %}">
                                <img src="/skins/icons/reload.png">{% trans "Substitute" %}
                            </button>
                        {% endif %}
                    </div>
                </div>
            </li>
        </ul>
        {# Store lazaret file id in hidden input #}
        <input type="hidden" name="lazaret_file" value="{{ file.getId() }}"/>
        {# Store lazaret file destination #}
        <input type="hidden" name="lazaret_file_destination" value="{{ file.getBaseId() }}"/>
    </div>
    {% set record_count = records|length %}
    {% if record_count  > 0 %}
        <div class="lazaret-proposals span8">
            <h5>
            {% if record_count <= 1 %}
                {% trans %}
                    A record matches the unique identifier :
                {% endtrans %}
            {% else %}
                {% trans %}
                    {{ record_count }} records match the unique identifier :
                {% endtrans %}
            {% endif %}
            </h5>
            <ul class="thumbnails">
                {%  set thumbnailRender = {
                        size:140,
                        elements: constant('\\record_adapter::RENDER_THUMBNAIL_ALL')
                                - constant('\\record_adapter::RENDER_THUMBNAIL_DROPDOWN')
                                - constant('\\record_adapter::RENDER_THUMBNAIL_DBLCLK')
                    }
                %}
                {% for record in records %}
                    {% set reasons=record['reasons'] %}
                    {% set record=record['record'] %}
                    {% if app['authentication'].getUser().ACL().has_right_on_base(record.get_base_id(), "canaddrecord")
                        and app['authentication'].getUser().ACL().has_right_on_base(record.get_base_id(), "candeleterecord") %}
                        <li class="records-subititution" style="width:{{ thumbnailRender.size+40 }}px;">
                            <input type="hidden" name="record_id" value="{{ record.get_record_id() }}">
                            {{record_format.block(record, false, null, 'IMGT_CONFLICT', false, thumbnailRender)}}
                            <div class="caption" style="float:left;">
                            {% for reason in reasons %}
                                <p>{{ reason }}</p>
                            {% endfor %}
                            </div>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}
{% endmacro %}

