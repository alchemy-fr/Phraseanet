<html lang="{{ session.get_I18n() }}">
    <head>
        <title>{{ registry.get('GV_homeTitle') }} {% trans 'login:: Mon compte'%}</title>
        <link rel="stylesheet" type="text/css" href="/include/minify/f=login/home.css,/login/geonames.css,/skins/html5/bootstrap/css/bootstrap.min.css,/skins/html5/bootstrap/css/bootstrap-responsive.min.css,/skins/login/css/main.css"/>
        <link rel="stylesheet" type="text/css" href="/skins/login/css/main.css"/>
        <script type="text/javascript" language="javascript" src="/include/minify/f=include/jslibs/jquery-1.7.1.js"></script>
        <script type="text/javascript" language="javascript" src="/include/jslibs/jquery-ui-1.8.17/js/jquery-ui-1.8.17.custom.min.js"></script>
        <script type="text/javascript" src="/login/geonames.js"></script>
        <script type="text/javascript">
            $(document).ready(function(){

                var trans = {
                    'confirm_delete' : "<?php echo _('etes vous sur de vouloir supprimer cette application'); ?>"
                    ,'yes' : "<?php echo _('oui'); ?>"
                    ,'no' : "<?php echo _('non'); ?>"
                }
                $( "#tab-account-cat").tabs({
                    ajaxOptions: {
                        error: function( xhr, status, index, anchor ) {
                            $( anchor.hash ).html("<?php echo _('Erreur lors du chargement') ?>");
                        }
                    }
                });

                initialize_geoname_field($('#form_geonameid'));

                $("#generate_access").live("click", function(){
                    var app_id = $(this).attr("value");
                    var usr_id = $(this).closest("div").attr("id");
                    var opts = {
                        type:"POST",
                        url : '/api/oauthv2/applications/'+ app_id +'/generate_access_token/',
                        dataType: 'json',
                        data : {
                            usr_id : usr_id
                        },
                        success : function(data){
                            if(data.ok)
                                $("#my_access_token").empty().append(data.token);
                        }
                    }
                    jQuery.ajax(opts);
                });

                var $url_callback_event = function(event) {
                    if ( event.type == "mouseover" ) {
                        $(this).find(".modifier_callback").show();
                    } else {
                        $(this).find(".modifier_callback").hide();
                    }
                };

                var $event = function(event){
                    if ( event.type == "mouseover" ) {
                        $(this).find(".delete_app").show();
                    } else {
                        $(this).find(".delete_app").hide();
                    }
                };

                $(".url_callback").live("mouseover mouseout", $url_callback_event);

                $(".app-list li").live("mouseover mouseout", $event);

                $(".modifier_callback").live("click", function(){
                    $(this).hide();
                    $(".save_callback").show();
                    var cur_value = $(".url_callback_input").html();
                    $(".url_callback_input")
                    .empty()
                    .wrapInner('<input value = "'+cur_value+'" name="oauth_callback" size="50" type="text"/>');
                    $(".url_callback").die();
                    $(".save_callback").live("click", function(){
                        var callback = $("input[name=oauth_callback]").val();
                        var app_id = $("input[name=app_id]").val();
                        var $this = $(this);
                        var option = {
                            type:"POST",
                            url : "/api/oauthv2/applications/oauth_callback",
                            dataType: 'json',
                            data :{app_id : app_id, callback : callback},
                            success : function(data){
                                if(data.success == true)
                                    $(".url_callback_input").empty().append(callback);
                                else
                                    $(".url_callback_input").empty().append(cur_value);
                                $this.hide();
                                $(".url_callback").live("mouseover mouseout", $url_callback_event);
                            }
                        }
                        $.ajax(option);
                    });
                });

                $(".app_submit").live("click", function(){
                    var form = $(this).closest("form");
                    var action = form.attr("action");
                    var option = {
                        type:"POST",
                        url : action,
                        dataType: 'html',
                        data : form.serializeArray(),
                        success : function(data){
                            $(".ui-tabs-panel:visible").empty().append(data);
                        }
                    }
                    $.ajax(option);
                });

                $("#form_create input[name=type]").live("click", function(){
                    if($(this).val() == "desktop")
                        $("#form_create .callback td").hide().find("input").val('');
                    else
                        $("#form_create .callback td").show();
                });

                $('.grant-type').live('click', function(){
                    var appId = $(this).val();
                    var grant = $(this).is(":checked") ? "1": "0";
                    var opts = {
                        type:"POST",
                        url : '/api/oauthv2/applications/' + appId + '/grant_password/',
                        dataType: 'json',
                        data : {
                            grant : grant
                        },
                        success : function(data){

                        }
                    }
                    $.ajax(opts);
                });

                $(".app-btn").live("click", function(){

                    if (!$(this).hasClass("authorize"))
                    {
                        var revoke = 1;
                        var button_class = "authorize";
                        var old_class ="revoke";
                        var string  = "<?php echo _('Authoriser l\'access'); ?>";
                    }

                    if ($(this).hasClass("authorize"))
                    {
                        var revoke = 0;
                        var button_class = "revoke";
                        var old_class ="authorize";
                        var string  = "<?php echo _('Revoquer l\'access'); ?>";
                    }

                    var acc_id = $(this).attr("value");
                    var current = $(this);
                    var opts = {
                        type:"POST",
                        url : '/api/oauthv2/applications/revoke_access/',
                        dataType: 'json',
                        data : {
                            account_id : acc_id,
                            revoke : revoke
                        },
                        success : function(data){
                            if(data.ok)
                            {
                                div = current.closest("div");
                                current.removeClass(old_class).addClass(button_class);
                                current.attr("value", acc_id);
                                current.empty().append(string);
                            }
                        }
                    }
                    $.ajax(opts);
                });

                $("#app_dev, #app_dev_new, #app_dev_create, a.dev_back").live("click", function(e){
                    e.preventDefault();
                    target = $(this).attr("href");
                    var opts = {
                        type:"GET",
                        url : target,
                        dataType: 'html',
                        success : function(data){
                            $(".ui-tabs-panel:visible").empty().append(data);
                        }
                    }
                    $.ajax(opts);
                });

                $(".delete_app").die().live("click", function(){
                    var id = $(this).closest("li").attr('id').split("_");;
                    var app_id = id[1];
                    var $this= $(this);
                    $("body").append("<div id='confirm_delete'><p>"+trans.confirm_delete+" ? </p></div>")
                    $("#confirm_delete").dialog({
                        resizable: false,
                        autoOpen :true,
                        title: "",
                        draggable: false,
                        width:340,
                        modal: true,
                        buttons: [{
                                id: "ybutton",
                                text: trans.yes,
                                click: function() {
                                    var opts = {
                                        type:"DELETE",
                                        url : '/api/oauthv2/applications/'+ app_id,
                                        dataType: 'json',
                                        data : {},
                                        success : function(data){
                                            if(data.success == true)
                                            {
                                                $this.closest("li").remove();
                                                $("#confirm_delete").dialog("close");
                                            }
                                        }
                                    }
                                    $.ajax(opts);
                                }
                            },
                            {
                                id: "nbutton",
                                text: trans.no,
                                click: function() {
                                    $( this ).dialog( "close" );
                                }
                            }],
                        close : function() {
                            $( this ).remove();
                        }
                    });
                });

            });
        </script>
        <style type="text/css">
            .tab-content{
                height: auto;
            }
        </style>
    </head>

    <body>
        <div style="width: 950px; margin-left: auto; margin-right: auto;">
            <div style="margin-top: 70px; height: 35px;">
                <table style="width: 100%;">
                    <tr style="height: 35px;">
                        <td style="width: 580px;"><span class="title-name">{{ registry.get('GV_homeTitle') }}</span><span class="title-desc">{% trans 'login:: Mon compte' %}</span></td>
                        <td style="color: #b1b1b1; text-align: right;">
                        </td>
                    </tr>
                </table>
            </div>
            <div class="tab-pane">
                <div id="id-main" class="tab-content" style="display: block; overflow-y: auto; overflow-x: hidden;">
                    <div id="tab-account-cat">
                        <ul>
                            <li><a href="#tab-account-info">{% trans 'Informations' %}</a></li>
                            <li><a href="#tab-account-access">{% trans 'Acces' %}</a></li>
                            <li><a href="#tab-account-session">{% trans 'Sessions' %}</a></li>
                            <li><a href="/api/oauthv2/applications" title="tab-account-app">{% trans 'Applications' %}</a></li>
                            <li><a href="/api/oauthv2/applications/dev" title="tab-account-dev">{% trans 'Developpeur' %}</a></li>
                        </ul>
                        <!-- START TAB ACCESS -->
                        <div id="tab-account-info">
                            <table>
                                <tr valign="top">
                                    <td style="width: 98%">
                                        {% if notice != '' %}
                                            <div class="notice alert alert-error">{{ notice }}</div>
                                        {% endif %}
                                        <form name="account" id="account" class="form-horizontal" action="/login/account.php" method="post">
                                            <fieldset>

                                                <legend>{% trans 'Informations personnelles' %}</legend>
                                                <div class="control-group">
                                                    <div class="controls">
                                                        <p><a href="/login/reset-password.php" target="_self">{% trans 'admin::compte-utilisateur changer mon mot de passe' %}</a></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_login">{% trans 'admin::compte-utilisateur identifiant' %}</label>
                                                    <div class="controls">
                                                        <p>{{ user.get_login() }}</p>
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_gender">{% trans 'admin::compte-utilisateur sexe' %}</label>
                                                    <div class="controls">
                                                        <select>
                                                            <option {% if user.get_gender() == "0" %}selected{% endif %} value="0" >
                                                                {% trans 'admin::compte-utilisateur:sexe: mademoiselle' %}
                                                            </option>
                                                            <option {% if user.get_gender() == "1" %}selected{% endif %} value="1" >
                                                                {% trans 'admin::compte-utilisateur:sexe: madame' %}
                                                            </option>
                                                            <option {% if user.get_gender() == "2" %}selected{% endif %} value="2" >
                                                                {% trans 'admin::compte-utilisateur:sexe: monsieur' %}
                                                            </option>
                                                        </select>
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_lastname">{% trans 'admin::compte-utilisateur nom' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element" type="text" name="form_lastname" id="form_lastname" value="{{ user.get_lastname() }}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_firstname">{% trans 'admin::compte-utilisateur prenom' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element" type="text" name="form_firstname" id="form_firstname" value="{{ user.get_firstname() }}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_firstname">{% trans 'admin::compte-utilisateur email' %}</label>
                                                    <div class="controls">
                                                        <p>{{ user.get_email() }} <a href="/login/reset-email.php" target="_self">{% trans 'login:: Changer mon adresse email' %}</a></p>
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_address">{% trans 'admin::compte-utilisateur adresse' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element" type="text" name="form_address" id="form_address" value="{{ user.get_address() }}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_zip">{% trans 'admin::compte-utilisateur code postal' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element" type="text" name="form_zip" id="form_zip" value="{{ user.get_zipcode() }}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_city">{% trans 'admin::compte-utilisateur ville' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element geoname_field" type="text" name="form_geonameid" id="form_geonameid" geonameid="{{ user.get_geonameid() }}" value="{{ geonames.name_from_id(user.get_geonameid()) }}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label"></label>
                                                    <div class="controls">
                                                        <div id="test_city" style="position: absolute; width: 200px; max-height: 200px; overflow-y: auto; z-index: 99999;"></div>
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_function">{% trans 'admin::compte-utilisateur poste' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element" type="text" name="form_function" id="form_function" value="{{ user.get_position() }}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_company">{% trans 'admin::compte-utilisateur societe' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element" type="text" name="form_company" id="form_company" value="{{ user.get_company() }}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_activity">{% trans 'admin::compte-utilisateur activite' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element" type="text" name="form_activity" id="form_activity" value="{{ user.get_job() }}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_phone">{% trans 'admin::compte-utilisateur telephone' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element" type="text" name="form_phone" id="form_phone" value="{{ user.get_tel() }}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_fax">{% trans 'admin::compte-utilisateur fax' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element" type="text" name="form_fax" id="form_fax" value="{{ user.get_fax() }}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>

                                                <legend>{% trans 'Notification par email' %}</legend>
                                                {% for notification_group, nots in notifications%}
                                                    <p style="font-weight: bold;">{{ notification_group }}</p>
                                                    {% for notification in nots %}
                                                        <div class="control-group">
                                                            <label class="form_label control-label"></label>
                                                            <div class="controls">
                                                                <label class="checkbox" for="notif_{{ notification['id'] }}">
                                                                    <input type="checkbox" id="notif_{{ notification['id'] }}" name="notifications[{{ notification['id'] }}]" {% if not user.getPrefs('notification_' ~ notification['id']) == '0' %}checked{% endif %} value="1"/>
                                                                    {{ notification['description'] }}
                                                                </label>
                                                                <p class="form_alert help-block"></p>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% endfor %}

                                                <legend>{% trans 'FTP' %}</legend>
                                                <div class="control-group">
                                                    <label class="form_label control-label" for="form_activeFTP">{% trans 'admin::compte-utilisateur:ftp: Activer le compte FTP' %}</label>
                                                    <div class="controls">
                                                        <input class="input_element" type="checkbox" name="form_activeFTP" id="form_activeFTP" {% if user.get_activeftp() %}checked{% endif %} onchange="if(this.checked){$('#ftpinfos').slideDown();}else{$('#ftpinfos').slideUp();}" />
                                                        <p class="form_alert help-block"></p>
                                                    </div>
                                                </div>
                                                <div id="ftpinfos" style="display: {% if user.get_activeftp() %}block{% else %}none{% endif %}">
                                                    <div class="control-group">
                                                        <label class="form_label control-label" for="form_addrFTP">{% trans 'phraseanet:: adresse' %}</label>
                                                        <div class="controls">
                                                            <input class="input_element" type="text" name="form_addrFTP" id="form_addrFTP" value="{{ user.get_ftp_address() }}" />
                                                            <p class="form_alert help-block"></p>
                                                        </div>
                                                    </div>
                                                    <div class="control-group">
                                                        <label class="form_label control-label" for="form_loginFTP">{% trans 'admin::compte-utilisateur identifiant' %}</label>
                                                        <div class="controls">
                                                            <input class="input_element" type="text" name="form_loginFTP" id="form_loginFTP" value="{{ user.get_ftp_login() }}" />
                                                            <p class="form_alert help-block"></p>
                                                        </div>
                                                    </div>
                                                    <div class="control-group">
                                                        <label class="form_label control-label" for="form_pwdFTP">{% trans 'admin::compte-utilisateur mot de passe' %}</label>
                                                        <div class="controls">
                                                            <input class="input_element" type="text" name="form_pwdFTP" id="form_pwdFTP" value="{{ user.get_ftp_password() }}" />
                                                            <p class="form_alert help-block"></p>
                                                        </div>
                                                    </div>
                                                    <div class="control-group">
                                                        <label class="form_label control-label" for="form_destFTP">{% trans 'admin::compte-utilisateur:ftp:  repertoire de destination ftp' %}</label>
                                                        <div class="controls">
                                                            <input class="input_element" type="text" name="form_destFTP" id="form_destFTP" value="{{ user.get_ftp_dir() }}" />
                                                            <p class="form_alert help-block"></p>
                                                        </div>
                                                    </div>
                                                    <div class="control-group">
                                                        <label class="form_label control-label" for="form_prefixFTPfolder">{% trans 'admin::compte-utilisateur:ftp: prefixe des noms de dossier ftp' %}</label>
                                                        <div class="controls">
                                                            <input class="input_element" type="text" name="form_prefixFTPfolder" id="form_prefixFTPfolder" value="{{ user.get_ftp_dir_prefix() }}" />
                                                            <p class="form_alert help-block"></p>
                                                        </div>
                                                    </div>
                                                    <div class="control-group">
                                                        <label class="form_label control-label" for="form_passifFTP">{% trans 'admin::compte-utilisateur:ftp: Utiliser le mode passif' %}</label>
                                                        <div class="controls">
                                                            <input class="input_element" type="checkbox" name="form_passifFTP" id="form_passifFTP" {% if user.get_ftp_passif() == "1" %}checked{% endif %} />
                                                            <p class="form_alert help-block"></p>
                                                        </div>
                                                    </div>
                                                    <div class="control-group">
                                                        <label class="form_label control-label" for="form_retryFTP">{% trans 'admin::compte-utilisateur:ftp: Nombre d\'essais max' %}</label>
                                                        <div class="controls">
                                                            <input class="input_element" type="text" name="form_retryFTP" id="form_retryFTP" value="5" />
                                                            <p class="form_alert help-block"></p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="form-actions" style="background-color: transparent;">
                                                    <input type="submit" class="btn btn-primary" value="{% trans 'boutton::valider' %}">
                                                </div>
                                            </fieldset>
                                        </form>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <!-- END TAB ACCOUNT -->
                        <!-- START TAB ACCESS -->
                        <div id="tab-account-access">
                            <form name="updatingDemand" id="updatingDemand" action="/login/account.php" method="post">
                                {{ demandes['tab'] |raw }}
                                <input type="submit" class="btn btn-info" value="{% trans 'boutton::valider' %}"/>
                            </form>
                        </div>
                        <!-- END TAB ACCESS -->
                        <!-- START TAB SESSION -->
                        <div id="tab-account-session">
                            <table style="width: 80%; margin: 0 auto;">
                                <thead>
                                    <tr>
                                        <th colspan="7" style="text-align: left;">
                                            {% trans 'Mes sessions' %}
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                        </td>
                                        <td>
                                            {% trans 'Date de connexion' %}
                                        </td>
                                        <td>
                                            {% trans 'Dernier access' %}
                                        </td>
                                        <td>
                                            {% trans 'IP' %}
                                        </td>
                                        <td>
                                            {% trans 'Browser' %}
                                        </td>
                                        <td>
                                            {% trans 'ecran' %}
                                        </td>
                                        <td>
                                            {% trans 'Session persistante' %}
                                        </td>
                                    </tr>
                                    {% for row in session.get_my_sessions() %}
                                        <tr>
                                            <td>
                                                {% if session.get_ses_id() != row['session_id'] %}
                                                    <img src="/skins/icons/delete.png"/>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ row['created_on'] |getDate }}
                                            </td>
                                            <td>
                                                {{ row['lastaccess'] |getDate }}
                                            </td>
                                            <td>
                                                {{ row['ip'] }}
                                                {{ row['ip_infos'] }}
                                            </td>
                                            <td>
                                                {{ row['browser'] }} {{ row['browser_version'] }}
                                            </td>
                                            <td>
                                                {{ row['screen'] }}
                                            </td>
                                            <td>
                                                {% if row['token'] %}oui{% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- END TAB SESSION -->
                        <!-- START TAB APPLICATION -->
                        <div id="tab-account-app"></div>
                        <!-- END TAB SESSION -->
                        <!-- START TAB APPLICATION -->
                        <div id="tab-account-dev"></div>
                        <!-- END TAB SESSION -->
                    </div>
                </div>
                <div style="text-align: right; position: relative; margin: 18px 10px 0 0; font-size: 10px; font-weight: normal;">
                    <span>&copy; Copyright Alchemy 2005-{{ "now"|date("Y") }}</span>
                </div>
            </div>
        </div>
    </body>
</html>
